name: QGPS Industrial Autopilot
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  autopilot:
    runs-on: windows-latest
    strategy:
      matrix:
        repo: [axiomcore, rugged-silo, veo3]
    
    steps:
      - name: Checkout main repository (axiomcore)
        uses: actions/checkout@v3
      
      - name: Checkout target repository
        uses: actions/checkout@v3
        with:
          repository: TechFusion-Quantum-Global-Platform/${{ matrix.repo }}
          path: ${{ matrix.repo }}
        continue-on-error: true
      
      - name: Check if target repo was cloned
        id: check-repo
        shell: pwsh
        run: |
          $targetPath = "${{ github.workspace }}/${{ matrix.repo }}"
          if (Test-Path $targetPath) {
            Write-Host "Target repository found at: $targetPath"
            "repo_exists=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "Target repository not found, skipping sync/compliance for ${{ matrix.repo }}"
            "repo_exists=false" >> $env:GITHUB_OUTPUT
          }
      
      - name: Brain Sync
        if: steps.check-repo.outputs.repo_exists == 'true'
        shell: pwsh
        run: |
          $RootPath = "${{ github.workspace }}"
          & "$RootPath\scripts\axiom-sync.ps1" -RepoPath "${{ github.workspace }}/${{ matrix.repo }}"
      
      - name: Compliance Check
        if: steps.check-repo.outputs.repo_exists == 'true'
        shell: pwsh
        run: |
          $RootPath = "${{ github.workspace }}"
          & "$RootPath\scripts\axiom-compliance.ps1" -RepoPath "${{ github.workspace }}/${{ matrix.repo }}"
      
      - name: Run Orchestrator
        if: success()
        shell: pwsh
        run: |
          $RootPath = "${{ github.workspace }}"
          & "$RootPath\scripts\axiom-orchestrator.ps1" -Action status
      
      - name: Upload Compliance Logs
        uses: actions/upload-artifact@v4
        if: always() && steps.check-repo.outputs.repo_exists == 'true'
        with:
          name: compliance-logs-${{ matrix.repo }}
          path: ${{ github.workspace }}/${{ matrix.repo }}/.brain/compliance-log.json
          if-no-files-found: warn
      
      - name: Upload Sync Metadata
        uses: actions/upload-artifact@v4
        if: always() && steps.check-repo.outputs.repo_exists == 'true'
        with:
          name: sync-metadata-${{ matrix.repo }}
          path: ${{ github.workspace }}/${{ matrix.repo }}/.brain/sync-metadata.json
          if-no-files-found: warn
