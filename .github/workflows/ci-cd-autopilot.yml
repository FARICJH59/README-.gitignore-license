name: QGPS Industrial Autopilot
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  autopilot:
    runs-on: windows-latest
    strategy:
      matrix:
        repo: [axiomcore, rugged-silo, veo3]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          path: ${{ matrix.repo }}
      
      - name: Brain Sync
        shell: pwsh
        run: |
          $RepoPath = "${{ github.workspace }}\${{ matrix.repo }}"
          & "$RepoPath\scripts\axiom-sync.ps1" -RepoPath $RepoPath
      
      - name: Compliance Check
        shell: pwsh
        run: |
          $RepoPath = "${{ github.workspace }}\${{ matrix.repo }}"
          & "$RepoPath\scripts\axiom-compliance.ps1" -RepoPath $RepoPath
      
      - name: Run Orchestrator
        if: success()
        shell: pwsh
        run: |
          $RepoPath = "${{ github.workspace }}\${{ matrix.repo }}"
          & "$RepoPath\scripts\axiom-orchestrator.ps1" -Action status
      
      - name: Upload Compliance Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compliance-logs-${{ matrix.repo }}
          path: ${{ github.workspace }}/${{ matrix.repo }}/.brain/compliance-log.json
          if-no-files-found: warn
      
      - name: Upload Sync Metadata
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sync-metadata-${{ matrix.repo }}
          path: ${{ github.workspace }}/${{ matrix.repo }}/.brain/sync-metadata.json
          if-no-files-found: warn
