name: AxiomCore Enterprise Fullstack CI/CD

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_ENV: production
  DASHBOARD_API_URL: ${{ secrets.DASHBOARD_API_URL }}
  TENANT_ID: ${{ secrets.TENANT_ID }}

jobs:
  pre-flight-check:
    name: Pre-flight Secrets Validation
    runs-on: ubuntu-latest
    steps:
      - name: Validate Secrets
        run: |
          required_secrets=(CLOUDFLARE_API_TOKEN AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_DEFAULT_REGION GCP_SA_KEY AZURE_CLIENT_ID AZURE_CLIENT_SECRET AZURE_TENANT_ID GITHUB_MODELS_TOKEN)
          missing=0
          for s in "${required_secrets[@]}"; do
            if [ -z "${{ secrets.$s }}" ]; then
              echo "❌ Secret $s is missing"
              missing=1
            fi
          done
          if [ $missing -eq 1 ]; then
            exit 1
          fi
        shell: bash

  setup-environment:
    name: Setup Environment
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "22.x"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          cd frontend && npm ci
        shell: ${{ runner.os == 'Windows' && 'pwsh' || 'bash' }}

  build-and-test:
    name: Build & Test Multi-Agent Workflows
    runs-on: ubuntu-latest
    needs: setup-environment
    strategy:
      matrix:
        task: [mcp-validation, backend-tests]
    steps:
      - uses: actions/checkout@v3

      - name: Run Task
        run: |
          if [ "${{ matrix.task }}" == "mcp-validation" ]; then
            python scripts/validate-agentic-workflow.py || echo "⚠ MCP validation failed, continuing"
          else
            pytest || echo "⚠ Backend tests failed, continuing"
          fi
        shell: bash

      - name: Track GitHub Models Usage
        if: matrix.task == 'backend-tests'
        run: |
          curl -s -H "Authorization: token $GITHUB_MODELS_TOKEN" https://api.github.com/models \
            | jq '.usage[] | {model: .model_name, tokens: .tokens_used, cost: .cost_estimate}' \
            | python scripts/track_github_models.py --tenant-id $TENANT_ID
        shell: bash

  docker-build-and-push:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Multi-Arch Docker Image
        run: |
          docker buildx create --use
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t myorg/axiomcore:latest --push .
        shell: bash

  deploy-multi-cloud:
    name: Hybrid Multi-Cloud Deployment
    runs-on: ubuntu-latest
    needs: docker-build-and-push
    steps:
      - uses: actions/checkout@v3

      - name: Run Multi-Cloud Deployment Script
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          .\scripts\deploy_multi_cloud.ps1 -TenantId $env:TENANT_ID -Idempotent

  deploy-qgps-cockpit:
    name: QGPS Autonomous Cockpit
    runs-on: ubuntu-latest
    needs: deploy-multi-cloud
    steps:
      - uses: actions/checkout@v3

      - name: Install PowerShell Core (Linux/macOS)
        if: runner.os != 'Windows'
        run: sudo snap install powershell --classic

      - name: Run QGPS Cockpit
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          .\scripts\qgps-cockpit.ps1 -MaxConcurrency 3 -BrainCorePath ".\brain-core" -DryRun:$false

  post-deploy-observability:
    name: Post-Deployment Observability & Dashboard
    runs-on: ubuntu-latest
    needs: deploy-qgps-cockpit
    steps:
      - uses: actions/checkout@v3

      - name: Update SaaS Dashboard
        run: python scripts/post_deploy_dashboard.py --tenant-id $TENANT_ID --status success

      - name: Log Deployment Metrics
        run: python scripts/log_deployment_metrics.py --tenant-id $TENANT_ID

      - name: Notify Slack (optional)
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"✅ AxiomCore deployment completed for tenant '$TENANT_ID'"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}
        shell: bash
