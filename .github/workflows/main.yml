name: Deploy AxiomCore Autonomous Stack

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest
    env:
      NODE_ENV: production
      # GitHub Models usage tracking
      GITHUB_MODELS_API_URL: https://api.github.com/models
      GITHUB_MODELS_TOKEN: ${{ secrets.GITHUB_MODELS_TOKEN }}

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22.x'

      # 3Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 4Ô∏è‚É£ Setup Docker
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      # 5Ô∏è‚É£ Authenticate to Google Cloud (optional)
      - name: Authenticate to Google Cloud
        if: ${{ secrets.GCP_SA_KEY != '' }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 6Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          npm ci
          pip install -r requirements.txt

      # 7Ô∏è‚É£ Run the full-stack deployment script
      - name: Deploy AxiomCore Fullstack
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          .\scripts\deploy-axiomcore-fullstack.ps1

      # 8Ô∏è‚É£ Validate agentic multi-agent workflows (MCP)
      - name: Run MCP validation
        shell: pwsh
        run: |
          .\scripts\validate-agentic-workflow.ps1
          # Optional: log MCP validation results
          Write-Host "‚úÖ MCP validation completed."

      # 9Ô∏è‚É£ Track GitHub Models usage for billing / revenue
      - name: Track GitHub Models Usage
        run: |
          echo "Fetching model usage for revenue insights..."
          curl -s -H "Authorization: token $GITHUB_MODELS_TOKEN" $GITHUB_MODELS_API_URL \
            | jq '.usage[] | {model: .model_name, tokens: .tokens_used, cost: .cost_estimate}'

      # üîü Optional: Post-deploy status
      - name: Deployment completed
        run: Write-Host "‚úÖ Full-stack autonomous deployment completed successfully!"
