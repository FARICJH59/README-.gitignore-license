name: AxiomCore Autonomous CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

env:
  NODE_VERSION: 20
  PYTHON_VERSION: 3.12
  DOCKER_IMAGE_NAME: axiomcore/platform
  MULTI_ARCH: linux/amd64,linux/arm64
  DRY_RUN: false
  DEPLOY_ENV: production

# -------------------------------------------------
# 1️⃣ PREFLIGHT SECRETS VALIDATION
# -------------------------------------------------
jobs:
  preflight-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Validate Required Secrets
        run: |
          required_secrets=(
            "${{ secrets.DOCKER_HUB_USERNAME }}"
            "${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}"
            "${{ secrets.SLACK_BOT_TOKEN }}"
          )

          for secret in "${required_secrets[@]}"; do
            if [ -z "$secret" ]; then
              echo "❌ Missing required secret"
              exit 1
            fi
          done
          echo "✅ Secrets validated"

# -------------------------------------------------
# 2️⃣ WORKFLOW DRIFT SELF-HEAL (SAFE)
# -------------------------------------------------
  workflow-drift-selfheal:
    runs-on: ubuntu-latest
    needs: preflight-secrets
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Generate Self-Healed YAML
        run: |
          python scripts/check_workflow_drift_selfheal.py \
            --output .github/workflows/selfheal-preview.yml

      - name: Upload Self-Heal Artifact
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: workflow-selfheal-preview
          path: .github/workflows/selfheal-preview.yml

# -------------------------------------------------
# 3️⃣ BUILD & TEST
# -------------------------------------------------
  build-and-test:
    runs-on: ubuntu-latest
    needs: workflow-drift-selfheal
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: npm ci
      - run: pip install -r requirements.txt
      - run: pytest tests/

# -------------------------------------------------
# 4️⃣ DOCKER MULTI-ARCH BUILD
# -------------------------------------------------
  docker-multiarch:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Build & Push
        run: |
          if [ "${{ env.DRY_RUN }}" = "true" ]; then
            echo "Dry run – no push"
          else
            docker buildx build \
              --platform ${{ env.MULTI_ARCH }} \
              --push \
              -t ${{ env.DOCKER_IMAGE_NAME }}:latest .
          fi

# -------------------------------------------------
# 5️⃣ DEPLOY CLOUDFLARE (SAFE)
# -------------------------------------------------
  deploy-cloudflare:
    runs-on: ubuntu-latest
    needs: docker-multiarch
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Deploy via Wrangler Action
        if: env.DRY_RUN != 'true'
        uses: cloudflare/wrangler-action@v2
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}

# -------------------------------------------------
# 6️⃣ POST-DEPLOY OBSERVABILITY + SLACK
# -------------------------------------------------
  post-deploy-observability:
    runs-on: ubuntu-latest
    needs:
      - deploy-cloudflare
    steps:
      - uses: actions/checkout@v4

      - name: Generate Mermaid Dashboard
        run: bash scripts/generate_mermaid_dashboard.sh

      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        with:
          payload: |
            {
              "channel": "${{ secrets.SLACK_CHANNEL_ID }}",
              "text": "AxiomCore Deployment Completed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Cloudflare:* ${{ needs.deploy-cloudflare.result }}"
                  }
                }
              ]
            }

# -------------------------------------------------
# 7️⃣ QGPS TELEMETRY EXPORT
# -------------------------------------------------
  qgps-telemetry:
    runs-on: ubuntu-latest
    needs:
      - deploy-cloudflare
    steps:
      - name: Generate Telemetry JSON
        run: |
          cat <<EOF > qgps-status.json
          {
            "cloudflare": "${{ needs.deploy-cloudflare.result }}",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF

      - uses: actions/upload-artifact@v4
        with:
          name: qgps-telemetry
          path: qgps-status.json
