name: AxiomCore Enterprise CI/CD w/Self-Healing + Email Alerts

on:
  push:
    branches: [main, staging, dev]

jobs:

  setup-environment:
    runs-on: ubuntu-latest
    outputs:
      workspace: ${{ steps.workspace.outputs.path }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install PowerShell Core
        uses: PowerShell/PowerShell@v7.5.4

      - name: Determine Workspace Root
        id: workspace
        run: |
          echo "path=$(pwd)" >> $GITHUB_OUTPUT

  backend-build-deploy:
    runs-on: ubuntu-latest
    needs: setup-environment
    steps:
      - uses: actions/checkout@v4

      - name: Install Backend Dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Backend Tests
        continue-on-error: false
        run: |
          cd backend
          pytest tests

      - name: Build Backend Docker Image
        continue-on-error: false
        run: |
          cd backend
          docker build -t gcr.io/$GCP_PROJECT_ID/axiomcore-backend:latest .

      - name: Push Backend Docker Image
        continue-on-error: false
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          echo $GCP_SA_KEY | gcloud auth activate-service-account --key-file=-
          gcloud auth configure-docker
          docker push gcr.io/$GCP_PROJECT_ID/axiomcore-backend:latest

      - name: Deploy Backend to Cloud Run with Self-Healing
        continue-on-error: true
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          REGION: ${{ secrets.GCP_REGION }}
        run: |
          set -e
          echo "Deploying backend..."
          gcloud run deploy axiomcore-backend \
            --image gcr.io/$GCP_PROJECT_ID/axiomcore-backend:latest \
            --region $REGION \
            --platform managed \
            --allow-unauthenticated || echo "⚠️ Deployment failed, triggering rollback..."
          # Rollback to last stable image
          LAST_STABLE=$(gcloud container images list-tags gcr.io/$GCP_PROJECT_ID/axiomcore-backend --filter="tags:stable" --limit=1 --format="get(digest)")
          if [ -n "$LAST_STABLE" ]; then
            gcloud run deploy axiomcore-backend \
              --image gcr.io/$GCP_PROJECT_ID/axiomcore-backend@$LAST_STABLE \
              --region $REGION \
              --platform managed \
              --allow-unauthenticated
          fi

      - name: Send Backend Notification Email
        if: failure() || always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "⚠️ AxiomCore Backend Self-Healing Alert"
          body: |
            Workflow: ${{ github.workflow }}
            Job: ${{ github.job }}
            Status: ${{ job.status }}
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Time: $(date)
            Check cockpit logs: .brain/cockpit-log.json
          to: farichva@gmail.com
          from: farichva@gmail.com
          secure: true

  frontend-build-deploy:
    runs-on: ubuntu-latest
    needs: setup-environment
    steps:
      - uses: actions/checkout@v4

      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm install

      - name: Build Frontend Production Assets
        continue-on-error: false
        run: |
          cd frontend
          npm run build

      - name: Deploy Frontend to Cloudflare Pages
        continue-on-error: true
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          projectName: ${{ secrets.CF_PROJECT_NAME }}
          directory: ./frontend/dist

      - name: Send Frontend Notification Email
        if: failure() || always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "⚠️ AxiomCore Frontend Self-Healing Alert"
          body: |
            Workflow: ${{ github.workflow }}
            Job: ${{ github.job }}
            Status: ${{ job.status }}
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Time: $(date)
            Check cockpit logs: .brain/cockpit-log.json
          to: farichva@gmail.com
          from: farichva@gmail.com
          secure: true

  launch-qgps-cockpit:
    runs-on: ubuntu-latest
    needs: [setup-environment, backend-build-deploy, frontend-build-deploy]
    steps:
      - uses: actions/checkout@v4

      - name: Run TECHFUSION-QGPS.ps1 in Production Mode
        shell: pwsh
        run: |
          $MaxConcurrency = 2
          $Mode = "prod"
          & "${{ github.workspace }}/scripts/TECHFUSION-QGPS.ps1" -MaxConcurrency $MaxConcurrency -Mode $Mode

      - name: Upload Cockpit Log Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cockpit-log
          path: .brain/cockpit-log.json
