# File: .github/workflows/axiomcore-deploy.yml
name: AxiomCore Full Deployment

# Trigger on push to main or on manual workflow dispatch
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  setup-environment:
    name: Setup Cross-Platform Environment
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Install jq for JSON parsing
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            choco install jq -y
          else
            sudo apt-get update && sudo apt-get install jq -y
          fi

      - name: Install Cloudflare Wrangler CLI
        run: npm install -g wrangler

      - name: Configure Secrets
        run: |
          echo "Configuring secrets..."
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          GITHUB_MODELS_TOKEN: ${{ secrets.GITHUB_MODELS_TOKEN }}

  build-and-test:
    name: Build and Test Multi-Agent Workflows
    runs-on: ubuntu-latest
    needs: setup-environment
    continue-on-error: true # Non-blocking observability
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Validate MCP & Typed Schemas
        run: |
          echo "Validating multi-agent workflows..."
          python scripts/validate_mcp.py --schema-dir schemas/
        continue-on-error: true

      - name: Run Unit Tests for Agents
        run: |
          npm install
          npm test
        continue-on-error: true

      - name: Track GitHub Models Usage (Optional)
        run: |
          python scripts/github_models_usage.py
        env:
          GITHUB_MODELS_TOKEN: ${{ secrets.GITHUB_MODELS_TOKEN }}
        continue-on-error: true

  docker-build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Images
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t myorg/axiomcore:latest \
            --push .

  deploy-cloudflare:
    name: Deploy to Cloudflare Workers & Pages
    runs-on: ubuntu-latest
    needs: docker-build-and-push
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Authenticate Wrangler
        run: wrangler login
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Deploy Workers
        run: |
          wrangler publish ./workers
        continue-on-error: true

      - name: Deploy Pages
        run: |
          wrangler pages publish ./client --project-name=axiomcore-pages
        continue-on-error: true

      - name: Setup KV Storage & Durable Objects
        run: |
          wrangler kv:namespace create "axiomcore-kv"
          wrangler d1:database create "axiomcore-do"
        continue-on-error: true

  post-deploy-observability:
    name: Client Panel Integration & Analytics
    runs-on: ubuntu-latest
    needs: deploy-cloudflare
    steps:
      - name: Update Client Panel with Deployment Status
        run: |
          python scripts/update_client_panel.py --status success
        continue-on-error: true

      - name: Log Deployment Events
        run: |
          python scripts/log_events.py
        continue-on-error: true

      - name: Optionally Update Analytics Dashboard
        run: |
          python scripts/update_dashboard.py
        continue-on-error: true
