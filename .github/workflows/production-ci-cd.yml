name: Production CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review, edited, converted_to_draft]
  workflow_dispatch:

env:
  NODE_VERSION: "22.x"
  PYTHON_VERSION: "3.12"

jobs:
  governance:
    name: branch-governance
    runs-on: ubuntu-latest
    permissions:
      contents: read
      administration: write
    steps:
      - name: Enforce main branch governance
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = "main";
            const requiredContexts = [
              "lint-js",
              "lint-python",
              "lint-powershell",
              "compliance-check",
              "build",
              "test"
            ];
            try {
              await github.request("PUT /repos/{owner}/{repo}/branches/{branch}/protection", {
                owner,
                repo,
                branch,
                required_status_checks: {
                  strict: true,
                  contexts: requiredContexts
                },
                enforce_admins: true,
                required_pull_request_reviews: null,
                restrictions: null,
                required_linear_history: true,
                allow_force_pushes: false,
                allow_deletions: false,
                block_creations: false
              });
              core.info(`✅ Branch protection enforced for ${branch}`);
            } catch (error) {
              core.setFailed(`❌ Failed to enforce branch governance for ${branch}: ${error.message}`);
            }

  lint-js:
    name: lint-js
    runs-on: ubuntu-latest
    needs: governance
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Resolve package directory
        id: pkg-dir
        run: |
          if [ -f package.json ]; then
            echo "dir=." >> "$GITHUB_OUTPUT"
          elif [ -f frontend/package.json ]; then
            echo "dir=frontend" >> "$GITHUB_OUTPUT"
          else
            echo "dir=" >> "$GITHUB_OUTPUT"
          fi
      - name: Ensure npm lockfile
        run: |
          if [ -z "${{ steps.pkg-dir.outputs.dir }}" ]; then
            echo "package.json not found (root or frontend). Add a manifest to run lint-js."
            exit 1
          fi
          cd "${{ steps.pkg-dir.outputs.dir }}"
          if [ ! -f package-lock.json ]; then
            npm install --package-lock-only
          fi
      - name: Install frontend dependencies
        run: |
          cd "${{ steps.pkg-dir.outputs.dir }}"
          npm ci || npm install
      - name: Run ESLint
        run: |
          mkdir -p artifacts
          cd "${{ steps.pkg-dir.outputs.dir }}"
          log_path="${GITHUB_WORKSPACE}/artifacts/lint-js.log"
          npx eslint . --ext .js,.jsx,.ts,.tsx --max-warnings=0 | tee "$log_path"
      - name: Upload lint-js results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-js-results
          path: artifacts/lint-js.log
          if-no-files-found: warn

  lint-python:
    name: lint-python
    runs-on: ubuntu-latest
    needs: governance
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Detect Python sources
        id: pyfiles
        run: |
          files=$(find api -type f -name "*.py" || true)
          if [ -z "$files" ]; then
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "No Python files found under api/. Skipping lint."
          else
            echo "$files" > python_files.txt
            echo "found=true" >> "$GITHUB_OUTPUT"
          fi
      - name: Install lint dependencies
        if: steps.pyfiles.outputs.found == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install pylint black
      - name: Run pylint
        if: steps.pyfiles.outputs.found == 'true'
        run: |
          mkdir -p artifacts
          pylint $(cat python_files.txt) | tee artifacts/lint-python.log
      - name: Run black (check)
        if: steps.pyfiles.outputs.found == 'true'
        run: |
          mkdir -p artifacts
          black --check $(cat python_files.txt) | tee -a artifacts/lint-python.log
      - name: Upload lint-python results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-python-results
          path: artifacts/lint-python.log
          if-no-files-found: warn

  lint-powershell:
    name: lint-powershell
    runs-on: ubuntu-latest
    needs: governance
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module PSScriptAnalyzer -Scope CurrentUser -Force -ErrorAction Stop
      - name: Run ScriptAnalyzer
        shell: pwsh
        run: |
          mkdir -p artifacts
          Invoke-ScriptAnalyzer -Path scripts -Recurse -Severity Error,Warning | Tee-Object -FilePath artifacts/lint-powershell.log
      - name: Upload lint-powershell results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-powershell-results
          path: artifacts/lint-powershell.log
          if-no-files-found: warn

  compliance-check:
    name: compliance-check
    runs-on: ubuntu-latest
    needs:
      - lint-js
      - lint-python
      - lint-powershell
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Run axiom-compliance (infra, security, versions)
        shell: pwsh
        run: |
          mkdir -p artifacts
          & "${{ github.workspace }}/scripts/axiom-compliance.ps1" -RepoPath "${{ github.workspace }}" 2>&1 | Tee-Object -FilePath artifacts/compliance.log
          $lockPath = Join-Path "${{ github.workspace }}" "package-lock.json"
          if (Test-Path $lockPath) {
            $lock = Get-Content $lockPath -Raw | ConvertFrom-Json
            $prerelease = @()
            if ($lock.dependencies) {
              foreach ($key in $lock.dependencies.Keys) {
                $version = $lock.dependencies[$key].version
                if ($version -match "-") { $prerelease += "$key@$version" }
              }
            }
            if ($prerelease.Count -gt 0) {
              Write-Error "Pre-release dependencies are not allowed in production: $($prerelease -join ', ')"
            }
          }
      - name: Upload compliance artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compliance-results
          path: |
            artifacts/compliance.log
            .brain/compliance-log.json
          if-no-files-found: warn

  build:
    name: build
    runs-on: ubuntu-latest
    needs: compliance-check
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Resolve package directory
        id: build-pkg-dir
        run: |
          if [ -f package.json ]; then
            echo "dir=." >> "$GITHUB_OUTPUT"
          elif [ -f frontend/package.json ]; then
            echo "dir=frontend" >> "$GITHUB_OUTPUT"
          else
            echo "dir=" >> "$GITHUB_OUTPUT"
          fi
      - name: Prepare npm dependencies
        run: |
          if [ -z "${{ steps.build-pkg-dir.outputs.dir }}" ]; then
            echo "package.json not found (root or frontend). Add a manifest to run the build."
            exit 1
          fi
          cd "${{ steps.build-pkg-dir.outputs.dir }}"
          if [ ! -f package-lock.json ]; then
            npm install --package-lock-only
          fi
          npm ci || npm install
      - name: Build frontend
        run: |
          cd "${{ steps.build-pkg-dir.outputs.dir }}"
          npm run build --if-present
      - name: Build backend (Python byte-compile)
        run: |
          python -m compileall api || true

  test:
    name: test
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Resolve package directory
        id: test-pkg-dir
        run: |
          if [ -f package.json ]; then
            echo "dir=." >> "$GITHUB_OUTPUT"
          elif [ -f frontend/package.json ]; then
            echo "dir=frontend" >> "$GITHUB_OUTPUT"
          else
            echo "dir=" >> "$GITHUB_OUTPUT"
          fi
      - name: Install frontend dependencies
        run: |
          if [ -z "${{ steps.test-pkg-dir.outputs.dir }}" ]; then
            echo "package.json not found (root or frontend). Add a manifest to run frontend tests."
            exit 1
          fi
          cd "${{ steps.test-pkg-dir.outputs.dir }}"
          if [ ! -f package-lock.json ]; then
            npm install --package-lock-only
          fi
          npm ci || npm install
      - name: Run frontend tests
        run: |
          cd "${{ steps.test-pkg-dir.outputs.dir }}"
          npm test -- --watch=false --ci --passWithNoTests
      - name: Run backend tests
        run: |
          if find api -type f -name \"test_*.py\" -o -name \"*_test.py\" | grep -q .; then
            pip install pytest
            pytest
          else
            echo \"No pytest suites found under api/. Skipping backend tests.\"
          fi

  copilot-review:
    name: copilot-code-review
    runs-on: ubuntu-latest
    needs:
      - lint-js
      - lint-python
      - lint-powershell
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    permissions:
      contents: read
      pull-requests: write
      checks: read
    steps:
      - uses: actions/checkout@v4
      - name: Run Copilot code review
        uses: github/copilot-code-review@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          event: ${{ github.event_name }}
