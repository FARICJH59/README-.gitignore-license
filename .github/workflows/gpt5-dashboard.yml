name: GPT-5 Dashboard & AxiomCore Full CI/CD

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 6 * * *" # Daily 06:00 UTC health/metrics run
  workflow_dispatch:

jobs:
  # -------------------------------
  # 1️⃣ GPT-5 Dashboard CI/CD: Build, Deploy & Monitor
  # -------------------------------
  build-deploy-monitor:
    runs-on: ubuntu-latest
    env:
      DEPLOY_REGION: us-central1
      CLOUD_RUN_PROJECTS: RUGGED-SILO-476415-P6,axiomcore-platform-642795357173
      EMAIL_ALERT: farichva@gmail.com

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 20 for frontend build
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Build frontend with Vite/Tailwind
        run: npm run build
        working-directory: frontend

      - name: Setup Python 3.11 for backend
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Quick backend sanity check
        run: python -m compileall backend

      - name: Build Docker image (multi-stage)
        run: docker build -t gpt5-dashboard:${{ github.sha }} -f backend/Dockerfile .

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: RUGGED-SILO-476415-P6

      - name: Build and deploy container to Cloud Run
        env:
          CLOUD_RUN_SERVICE: gpt5-dashboard
        run: |
          IFS=',' read -ra projects <<< "$CLOUD_RUN_PROJECTS"
          for project in "${projects[@]}"; do
            image="gcr.io/${project}/gpt5-dashboard:${GITHUB_SHA}"
            gcloud builds submit --project "$project" --tag "$image" --file backend/Dockerfile .
            gcloud run deploy "$CLOUD_RUN_SERVICE" \
              --image "$image" \
              --region "$DEPLOY_REGION" \
              --platform managed \
              --allow-unauthenticated \
              --port 8080 \
              --project "$project"
          done

      - name: Deploy frontend to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: gpt5-dashboard
          directory: frontend/dist

      - name: Run Cloud Run health monitor
        env:
          CLOUD_RUN_PROJECTS: ${{ env.CLOUD_RUN_PROJECTS }}
          DEPLOY_REGION: ${{ env.DEPLOY_REGION }}
          CLOUD_RUN_SERVICE: gpt5-dashboard
        run: python backend/scripts/monitor.py

      - name: Collect usage and billing metrics
        env:
          CLOUD_RUN_PROJECTS: ${{ env.CLOUD_RUN_PROJECTS }}
          DEPLOY_REGION: ${{ env.DEPLOY_REGION }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: python backend/scripts/collect_metrics.py

      - name: Upload metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: metrics-json
          path: backend/scripts/metrics.json

      - name: Send daily email alert with metrics
        env:
          ALERT_EMAIL_USER: ${{ secrets.ALERT_EMAIL_USER }}
          ALERT_EMAIL_PASS: ${{ secrets.ALERT_EMAIL_PASS }}
          EMAIL_ALERT: ${{ env.EMAIL_ALERT }}
        run: |
          python - <<'PY'
          import json, os, smtplib, ssl
          from email.message import EmailMessage

          metrics_path = "backend/scripts/metrics.json"
          metrics = {}
          if os.path.exists(metrics_path):
              with open(metrics_path) as f:
                  metrics = json.load(f)

          msg = EmailMessage()
          msg["Subject"] = "GPT-5 Dashboard metrics"
          msg["From"] = os.environ["ALERT_EMAIL_USER"]
          msg["To"] = os.environ.get("EMAIL_ALERT")
          msg.set_content(f"Latest metrics payload:\n\n{json.dumps(metrics, indent=2)}")

          context = ssl.create_default_context()
          with smtplib.SMTP_SSL("smtp.gmail.com", 465, context=context) as server:
              server.login(os.environ["ALERT_EMAIL_USER"], os.environ["ALERT_EMAIL_PASS"])
              server.send_message(msg)
          PY

  # -------------------------------
  # 2️⃣ AxiomCore Full Stack: Multi-Arch Docker Compose + Zero-Downtime + Rollback
  # -------------------------------
  axiomcore-deploy:
    needs: build-deploy-monitor
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      NODE_VERSION: 22
      PYTHON_VERSION: 3.12
      INTERNAL_PORT: 8080
      APP_PORT: 3000
      DEPLOY_HOST: ${{ secrets.AXIOMCORE_DEPLOY_SERVER }}
      DEPLOY_USER: ${{ secrets.AXIOMCORE_DEPLOY_USER }}
      DEPLOY_KEY: ${{ secrets.AXIOMCORE_DEPLOY_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine version and previous image
        id: version
        run: |
          VERSION=$(git describe --tags --always)
          PREV_IMAGE=$(ssh -i $DEPLOY_KEY $DEPLOY_USER@$DEPLOY_HOST "docker images axiomcore --format '{{.Repository}}:{{.Tag}}' | grep -v latest | head -n1")
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "PREV_IMAGE=$PREV_IMAGE" >> $GITHUB_ENV

      - name: Set up QEMU for multi-arch builds
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push multi-arch AxiomCore image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/axiomcore:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/axiomcore:${{ env.VERSION }}
          platforms: linux/amd64,linux/arm64
          build-args: |
            NODE_VERSION=${{ env.NODE_VERSION }}
            PYTHON_VERSION=${{ env.PYTHON_VERSION }}
            APP_PORT=${{ env.APP_PORT }}
            INTERNAL_PORT=${{ env.INTERNAL_PORT }}

      - name: Deploy Docker Compose stack with zero-downtime and rollback
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.AXIOMCORE_DEPLOY_SERVER }}
          username: ${{ secrets.AXIOMCORE_DEPLOY_USER }}
          key: ${{ secrets.AXIOMCORE_DEPLOY_KEY }}
          script: |
            cd C:\AxiomCore || mkdir C:\AxiomCore && cd C:\AxiomCore

            git pull origin main || git clone https://github.com/<your-repo>.git .

            docker-compose pull

            # Start new container
            docker-compose up -d --build --no-deps --force-recreate
            sleep 15

            NEW_CONTAINER=$(docker ps --filter "name=axiomcore-app" --format "{{.Names}}")
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' $NEW_CONTAINER 2>/dev/null || echo "unknown")

            if [ "$STATUS" != "healthy" ]; then
              echo "❌ Health check failed. Rolling back..."
              if [ -n "${PREV_IMAGE}" ]; then
                docker-compose down
                docker pull ${PREV_IMAGE}
                docker tag ${PREV_IMAGE} axiomcore:latest
                docker-compose up -d
                echo "✅ Rolled back to previous working version: ${PREV_IMAGE}"
              else
                echo "⚠️ No previous image found. Deployment failed."
                exit 1
              fi
            else
              echo "✅ Deployment successful. New version: $VERSION"
            fi
